---
title: "Database COVID/CASEN"
author: "Venegas, M & Lafferte, A"
date: "25 de abril de 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Ayudantía Estadística Multivariada: Creación de base de datos para insumo

El presente documento se enmarca en la realización de ayudantías para el ramo de Estadística Multivariada en su versión 2020 a cargo del profesor Juan Carlos Castilo.Este tiene por objetivo servir de ejemplo práctico para los estudiantes y motivar el uso de R en base a la exploración de situaciones contingentes.

En este documento se explorarán los datos respectivos al virus COVID - 19 y sus relaciones a nivel descriptivo con datos agregados a nivel comunal utilizando como fuente la Encuesta de Caracterización Socioeconomica (CASEN) 2017. El producto final del presente documento es una base de datos puesta a dispocisión para los/as estudiantes en el desarrollo de la guía práctica N°3.

El contenido que acá se presentará será dividido en tres secciones. La primera sección consistirá en la **limpieza y manejo de bases de datos**. Las acciones a realizar en esta primera sección serán las siguientes:

1) Se cargarán las bases de datos pertinentes para el ejercicio, a saber; base de datos de distribución de infectados con COVID 19 a nivel comunal y la CASEN 2017.
2) Se seleccionarán las variables acordes al ejercicio (por ejemplo, nivel socioeconomico, ingresos, edad, sexo etc.) y se renombrarán en caso de ser necesario.
3) En la base de datos de la CASEN 2017 se agruparán los datos a nivel comunal.
4) Se procederá a hacer un join con la base de datos del COVID 19 utilizando como llave la variable comuna.

La segunda sección consistirá en la realización de **descriptivos básicos** de variables de interés. Para esto se procederá de la siguiente manera:

1) Se eligirán comunas a trabajar en base a decisiones justificadas.
2) Se realizarán tablas de contingencia entre variables de interés y cantidad de contiagiados por comuna.
3) Se procederá a utilizar correlaciones r de pearson para conocer la relación entre variables de interés.

En la tercera y última sección se **reflexionarán** aspectos fundamentales sobre el manejo de datos hasta ahora trabajado y sobre las interpretaciones que se le pueden hacer a los descriptivos hechos.

## Primera sección: limpieza y manejo de bases de datos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide")

```

En primer lugar, cargaremos los paquetes necesarios para el ejercicio
```{r}
# Cargar paquetes a utilizar
pacman::p_load(
               dplyr,
               sjlabelled,
               readxl,
               xlsx,
               DescTools,
               psych,
               descr,
               expss,
               car
               )

```

Acto seguido, procedemos a cargar las bases de datos a utilizar
```{r}
#Base de datos COVID 19 al 25 de abril de 2020
BCV19C <- read.csv("CasosConfirmadosComuna.csv")

#Base de datos CASEN 2017
BCASEN <- read_spss("Casen 2017.sav")
```

En la base de datos de la CASEN 2017 se seleccionan las variables a utilizar:
```{r}

#Selcción variables en CASEN 
BCASEN1 <- BCASEN %>% select (comuna, 
                                  edad, 
                                  sexo, 
                                  y1, 
                                  s12, 
                                  educ, 
                                  yoprcorh, 
                                  dau,
                                  ytotcorh)
```

Una vez seleccionadas las variables exploraremos los datos en busca de anomalías o cosas a considerar:
```{r}
# Descriptios de las variables escogidas
summary(BCASEN1)
freq(BCASEN1$edad)
count(BCASEN1[BCASEN1$edad >99,])

# El summary acá realizado muestra los siguientes datos a considerar:

# Para la edad figura un máximo de 117 años. Esto lleva a indagar la cantidad de casos que presentan arriba de 99 años, en tanto se considera una edad que sobrepasa en demasía la media de expectativa de vida chilena. Existen 39 casos con edades mayor a 99 años. Debido al poco n, no se les atribuye la categoría de NA.
#*NOTA* Los valores "0" significan residentes menores de 1 año.

freq(BCASEN1$educ)

# Para la educación, hay 1132 casos NS/NR, los cuales corresponden al 0.52% de la muestra. Se traspasan a NA, bajo la justificación de que la categoría NS/NR no será de suma relevancia para la tarea propuesta en este documento.

BCASEN1$educ[BCASEN1$educ== 99] <- NA

freq(BCASEN1$s12)

# Para el sistema de salud al cual se está adscrito existen 5197 casos bajo la categoría "No sabe", correspondiente al 2.4% de la muestra. En tanto puede ser una categoría relevante para el análisis poterior no se le atribuye la categoría de NA.

freq(BCASEN1$y1)

# Para los ingresos, hay 4354 casos que reportan no saber sus ingresos, los cuales corresponden al 6.3% valido (sin contar NA) de la muestra. Se asignarán como NA considerando que no aportan mayor información a los análisis posteriores.
#*NOTA* Los valores "0" significa que no han percibido ingresos.

BCASEN1$y1[BCASEN1$y1== 99] <- NA

BCASEN1 <-sjlabelled::copy_labels(BCASEN1,BCASEN)

```

Se procede a etiquetar las variables seleccionadas para la CASEN 2017
```{r}
#Etiquetación de variables CASEN. Base COVID 19 por comuna no requiere recodificación. 
BCASEN1 <- BCASEN1 %>% rename("comuna"=comuna, 
                                        "edad"=edad, 
                                        "ingreso"=y1, 
                                        "sexo"=sexo, 
                                        "educ"=educ, 
                                        "decilautonomo"=dau, 
                                        "sistemasalud"=s12, 
                                        "ingresocorregidoprincipal"=yoprcorh,
                                        "ingresohogar" =ytotcorh)
```

Se procede a hacer un agrupamiento de las variables de la casen a partir de la comuna:
```{r}
# Variables numericas

#Ingreso individual por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_media = mean(ingreso, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_mediana = median(ingreso, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_desviacionestandar = sd(ingreso, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_ingind <- merge (BDC_memed, BDC_sd, by = "comuna")

#Ingreso hogar por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_media = mean(ingresohogar, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_mediana = median(ingresohogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_desviacionestandar = sd(ingresohogar, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_inghog <- merge (BDC_memed, BDC_sd, by = "comuna")


#Edad por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_media = mean(edad, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_mediana = median(edad, na.rm = TRUE))

# Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_desviacionestandar = sd(edad, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_edad <- merge (BDC_memed, BDC_sd, by = "comuna")


#Merges de las variables
BDC_ing <- merge(BDC_ingind, BDC_inghog, by = "comuna")
BDC_num <- merge(BDC_ing, BDC_edad, by = "comuna")

```

```{r}
# Variables categoricas
# Porcentaje de hombres por comuna

BDC_sexhom <- BCASEN1 %>%group_by(comuna)%>%summarise(hombre_porcentaje= length(which(sexo==1))/(length(which(sexo==1))+length(which(sexo==2))))

BDC_sexmuj <- BCASEN1 %>%group_by(comuna)%>%summarise(mujer_porcentaje= length(which(sexo==2))/(length(which(sexo==1))+length(which(sexo==2))))

BDC_sex <- merge(BDC_sexhom, BDC_sexmuj, by = "comuna")

# Porcentaje de Fonasa A por comuna
BDC_sist_fonA <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaA_porcentaje= length(which(sistemasalud==1))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje de Fonasa B por comuna
BDC_sist_fonB <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaB_porcentaje= length(which(sistemasalud==2))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje de Fonasa C por Comuna
BDC_sist_fonC <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaC_porcentaje= length(which(sistemasalud==3))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje de Fonasa D por comuna
BDC_sist_fonD <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaD_porcentaje= length(which(sistemasalud==4))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje de Fonasa No sabe grupo
BDC_sist_fonNS <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaNS_porcentaje= length(which(sistemasalud==5))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

#Merges FONASA
BDC_fonAyfonB <- merge(BDC_sist_fonA, BDC_sist_fonB, by = "comuna")
BDC_fonCyfonD <- merge(BDC_sist_fonC, BDC_sist_fonD, by = "comuna")
BDC_fonABCD <- merge(BDC_fonAyfonB, BDC_fonCyfonD, by = "comuna")
BDC_fon <- merge(BDC_fonABCD, BDC_sist_fonNS, by = "comuna")

# Porcentaje FFAA
BDC_sist_FFAA <- BCASEN1 %>%group_by(comuna)%>%summarise(FFAA_porcentaje= length(which(sistemasalud==6))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje Isapre
BDC_sist_isapre <- BCASEN1 %>%group_by(comuna)%>%summarise(isapre_porcentaje= length(which(sistemasalud==7))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje Ninguno (particular)
BDC_sist_ninguno_particular <- BCASEN1 %>%group_by(comuna)%>%summarise(ninguno_particular= length(which(sistemasalud==8))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje Otro sistema
BDC_sist_otro <- BCASEN1 %>%group_by(comuna)%>%summarise(otrosistema_porcentaje= length(which(sistemasalud==9))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

# Porcentaje No sabe
BDC_sist_NS <- BCASEN1 %>%group_by(comuna)%>%summarise(nosabegrupo_porcentaje= length(which(sistemasalud==99))/(length(which(sistemasalud==1))+length(which(sistemasalud==2)+length(which(sistemasalud==3) + length(which(sistemasalud==4)+ length(which(sistemasalud==5) + length(which(sistemasalud==6) + length(which(sistemasalud==7)+length(which(sistemasalud==8)+length(which(sistemasalud==9 + length(which(sistemasalud==99)))))))))))))

#Merges sistemas no fonasa
BDC_ffaeisapre <- merge(BDC_sist_FFAA, BDC_sist_isapre, by = "comuna")
BDC_ningunoyotro <- merge(BDC_sist_ninguno_particular, BDC_sist_otro, by= "comuna")
BDC_1234 <- merge(BDC_ffaeisapre, BDC_ningunoyotro, by = "comuna")
BDC_sist_nofon <- merge(BDC_1234, BDC_sist_NS, by = "comuna")


#Merge sistemas salud
BDC_sistsalud <- merge(BDC_fon, BDC_sist_nofon)
```





BCASEN1_1<- BCASEN1 %>% filter(sexo %in% 1)

BDC <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(sexo = sum(filter(sexo))

class(BCASEN1$sexo)

#Nivel educacional por comuna

#Sistema de salud por comuna

#sexo por comuna

#decil por comuna
```


