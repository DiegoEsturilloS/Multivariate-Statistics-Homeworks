---
title: "Database COVID/CASEN"
author: "Venegas, M & Lafferte, A"
date: "25 de abril de 2020"
output: html_document
---

# Ayudantía Estadística Multivariada: Creación de base de datos para insumo

Este documento tiene por objetivo construir una base de datos con la cual los y las estudiantes podrán explorar los datos respectivos al virus COVID - 19 y sus relaciones a nivel descriptivo con datos agregados a nivel comunal.Bajo esta propuesta es que se utilizarán como fuente la Encuesta de Caracterización Socioeconomica (CASEN) 2017 y la base de datos de contagiados con COVID 19 en el útimo informe epidemiológico brindado por el gobierno (25 de abril 2020). El producto final del presente documento es una base de datos puesta a dispocisión para los/as estudiantes en el desarrollo de la guía práctica N°3.

El contenido de este documento podría ser estructurado de la siguiente manera: una primera sección que consistirá en la **limpieza y manejo de bases de datos**. Las acciones a realizar en esta primera sección serán las siguientes:

1) Se cargarán las bases de datos pertinentes para el ejercicio, a saber; base de datos de distribución de infectados con COVID 19 a nivel comunal y la CASEN 2017.
2) Se seleccionarán las variables acordes al ejercicio (por ejemplo, nivel socioeconomico, ingresos, edad, sexo etc.) y se renombrarán en caso de ser necesario.
3) En la base de datos de la CASEN 2017 se agruparán los datos a nivel comunal.
4) Se procederá a hacer un join con la base de datos del COVID 19 utilizando como llave la variable comuna.

Y, si es que el tiempo así lo permite, una segunda sección que se propone en la realización de **descriptivos básicos** de variables de interés. Para esto se procedería de la siguiente manera:

1) Se eligirán comunas a trabajar en base a decisiones justificadas.
2) Se realizarán tablas de contingencia entre variables de interés y cantidad de contiagiados por comuna.
3) Se procederá a utilizar correlaciones r de pearson para conocer la relación entre variables de interés.

Cabe mencionar que este documento se focalizará estrictamente en una buena construcción de la base de datos, es decir; de la primera sección.

## Primera sección: limpieza y manejo de bases de datos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide")

```

En primer lugar, cargaremos los paquetes necesarios para el ejercicio
```{r}
# Cargar paquetes a utilizar
pacman::p_load(
               dplyr,
               sjlabelled,
               readxl,
               cran,
               openxlsx,
               DescTools,
               psych,
               descr,
               expss,
               car,
               writexl, 
               stargazer,
               kableExtra,
               sjmisc,
               sjPlot,
               )

```

Acto seguido, procedemos a cargar las bases de datos a utilizar
```{r}
#Base de datos COVID 19 al 25 de abril de 2020
BCV19c <- read.csv("CasosConfirmadosComuna.csv")

#Base de datos CASEN 2017
BCASEN <- read_spss("Casen 2017.sav")
```

En la base de datos de la CASEN 2017 se seleccionan las variables a utilizar:
```{r}

#Selcción variables en CASEN 
BCASEN1 <- BCASEN %>% select (comuna, 
                                  edad, 
                                  sexo, 
                                  y1, 
                                  s12, 
                                  educ, 
                                  yoprcorh, 
                                  dau,
                                  ytotcorh,
                                  esc)
```

Una vez seleccionadas las variables exploraremos los datos en busca de anomalías o cosas a considerar:
```{r}
#CASEN
# Descriptios de las variables escogidas
summary(BCASEN1)
freq(BCASEN1$edad)
count(BCASEN1[BCASEN1$edad >99,])

# El summary acá realizado muestra los siguientes datos a considerar:

# Para la edad figura un máximo de 117 años. Esto lleva a indagar la cantidad de casos que presentan arriba de 99 años, en tanto se considera una edad que sobrepasa en demasía la media de expectativa de vida chilena. Existen 39 casos con edades mayor a 99 años. Debido al poco n, no se les atribuye la categoría de NA.
#*NOTA* Los valores "0" significan residentes menores de 1 año.

freq(BCASEN1$educ)

# Para la educación, hay 1132 casos NS/NR, los cuales corresponden al 0.52% de la muestra. Se traspasan a NA, bajo la justificación de que la categoría NS/NR no será de suma relevancia para la tarea propuesta en este documento.

BCASEN1$educ[BCASEN1$educ== 99] <- NA

freq(BCASEN1$s12)

# Para el sistema de salud al cual se está adscrito existen 5197 casos bajo la categoría "No sabe", correspondiente al 2.4% de la muestra. En tanto puede ser una categoría relevante para el análisis poterior no se le atribuye la categoría de NA.

freq(BCASEN1$y1)

# Para los ingresos, hay 4354 casos que reportan no saber sus ingresos, los cuales corresponden al 6.3% valido (sin contar NA) de la muestra. Se asignarán como NA considerando que no aportan mayor información a los análisis posteriores.
#*NOTA* Los valores "0" significa que no han percibido ingresos.

BCASEN1$y1[BCASEN1$y1== 99] <- NA

BCASEN1 <-sjlabelled::copy_labels(BCASEN1,BCASEN)

#COVID- 19 COMUNA (DATOS MINSAL AL 25 De ABRIL DE 2020)
sjmisc::descr(BCV19c,
      show = c("label","range", "mean", "sd", "NA.prc", "n"))%>%
      kable(.,"markdown")


```

Se procede a etiquetar las variables seleccionadas para la CASEN 2017
```{r}
#Etiquetación de variables CASEN.
BCASEN1 <- BCASEN1 %>% rename("comuna"=comuna, 
                                        "edad"=edad, 
                                        "ingreso"=y1, 
                                        "sexo"=sexo, 
                                        "educ"=educ, 
                                        "decilautonomo"=dau, 
                                        "sistemasalud"=s12, 
                                        "ingresocorregidoprincipal"=yoprcorh,
                                        "ingresohogar" =ytotcorh)

#Etiquetación de variable comuna en base COVID19
BCV19c <- BCV19c %>% rename("comuna" = Codigo.comuna)
```


Se procede a hacer un agrupamiento de las variables de la casen a partir de la comuna:
```{r}
# Variables numericas

#Ingreso individual por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_media = mean(ingreso, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_mediana = median(ingreso, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_desviacionestandar = sd(ingreso, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_ingind <- merge (BDC_memed, BDC_sd, by = "comuna")

#Ingreso hogar por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_media = mean(ingresohogar, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_mediana = median(ingresohogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_desviacionestandar = sd(ingresohogar, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_inghog <- merge (BDC_memed, BDC_sd, by = "comuna")


#Edad por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_media = mean(edad, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_mediana = median(edad, na.rm = TRUE))

# Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_desviacionestandar = sd(edad, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_edad <- merge (BDC_memed, BDC_sd, by = "comuna")

# Años escolaridad por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_media = mean(esc, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_mediana = median(esc, na.rm = TRUE))

# Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_desviacionestandar = sd(esc, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_edan <- merge (BDC_memed, BDC_sd, by = "comuna")



#Merges de las variables
BDC_ing <- merge(BDC_ingind, BDC_inghog, by = "comuna")
BDC_ingyedad <- merge(BDC_ing, BDC_edad, by = "comuna")
BDC_num <- merge(BDC_ingyedad, BDC_edan, by = "comuna")

```

```{r}
# Variables categoricas

# Sexo
# Porcentaje de hombres por comuna

BDC_sexhom <- BCASEN1 %>%group_by(comuna)%>%summarise(hombre_porcentaje= length(which(sexo==1))
/(length(which(sexo==1))+
    length(which(sexo==2))))

BDC_sexmuj <- BCASEN1 %>%group_by(comuna)%>%summarise(mujer_porcentaje= length(which(sexo==2))
/(length(which(sexo==1))+
    length(which(sexo==2))))

# Merge sexos
BDC_sex <- merge(BDC_sexhom, BDC_sexmuj, by = "comuna")

#Comprobar
BDC_sex$total_sex <- BDC_sex$hombre_porcentaje + BDC_sex$mujer_porcentaje
any(BDC_sex$total_sex==!1)

#Sistema de salud
# Porcentaje de Fonasa A por comuna
BDC_sist_fonA <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaA_porcentaje= length(which(sistemasalud==1))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa B por comuna
BDC_sist_fonB <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaB_porcentaje= length(which(sistemasalud==2))           /(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa C por Comuna
BDC_sist_fonC <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaC_porcentaje= length(which(sistemasalud==3))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa D por comuna
BDC_sist_fonD <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaD_porcentaje= length(which(sistemasalud==4))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa No sabe grupo
BDC_sist_fonNS <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaNS_porcentaje= length(which(sistemasalud==5))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

#Merges FONASA
BDC_fonAyfonB <- merge(BDC_sist_fonA, BDC_sist_fonB, by = "comuna")
BDC_fonCyfonD <- merge(BDC_sist_fonC, BDC_sist_fonD, by = "comuna")
BDC_fonABCD <- merge(BDC_fonAyfonB, BDC_fonCyfonD, by = "comuna")
BDC_fon <- merge(BDC_fonABCD, BDC_sist_fonNS, by = "comuna")

# Porcentaje FFAA
BDC_sist_FFAA <- BCASEN1 %>%group_by(comuna)%>%summarise(FFAA_porcentaje= length(which(sistemasalud==6))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Isapre
BDC_sist_isapre <- BCASEN1 %>%group_by(comuna)%>%summarise(isapre_porcentaje= length(which(sistemasalud==7))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Ninguno (particular)
BDC_sist_ninguno_particular <- BCASEN1 %>%group_by(comuna)%>%summarise(ninguno_particular= length(which(sistemasalud==8))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Otro sistema
BDC_sist_otro <- BCASEN1 %>%group_by(comuna)%>%summarise(otrosistema_porcentaje= length(which(sistemasalud==9))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje No sabe
BDC_sist_NS <- BCASEN1 %>%group_by(comuna)%>%summarise(nosabegrupo_porcentaje= length(which(sistemasalud==99))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

#Merges sistemas no fonasa
BDC_ffaeisapre <- merge(BDC_sist_FFAA, BDC_sist_isapre, by = "comuna")
BDC_ningunoyotro <- merge(BDC_sist_ninguno_particular, BDC_sist_otro, by= "comuna")
BDC_1234 <- merge(BDC_ffaeisapre, BDC_ningunoyotro, by = "comuna")
BDC_sist_nofon <- merge(BDC_1234, BDC_sist_NS, by = "comuna")


#Merge sistemas salud
BDC_sistsalud <- merge(BDC_fon, BDC_sist_nofon)

# Comprobar
BDC_sistsalud$total_sistsalud <- BDC_sistsalud$fonasaA_porcentaje + BDC_sistsalud$fonasaB_porcentaje + BDC_sistsalud$fonasaC_porcentaje + BDC_sistsalud$fonasaD_porcentaje + BDC_sistsalud$fonasaNS_porcentaje + BDC_sistsalud$FFAA_porcentaje + BDC_sistsalud$isapre_porcentaje + BDC_sistsalud$ninguno_particular + BDC_sistsalud$otrosistema_porcentaje + BDC_sistsalud$nosabegrupo_porcentaje

any(BDC_sistsalud$total_sistsalud == ! 1)

#Nivel educacional 
#Porcentaje de sin educación formal por comuna 
BDC_educ_sin <- BCASEN1 %>%group_by(comuna)%>%summarise(sineducformal_porcentaje= 
length(which(educ==0))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))
                                                        
#Porcentaje de Basica incompleta por comuna 
BDC_educ_basic_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educbasicincomplete_porcentaje= 
length(which(educ==1))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Basica completa por comuna 
BDC_educ_basic_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educbasiccomplete_porcentaje= 
length(which(educ==2))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media humanista incompleta por comuna
BDC_educ_hum_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educhumincomplete_porcentaje= 
length(which(educ==3))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media técnica profesional incompleta por comuna
BDC_educ_tec_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(eductecincomplete_porcentaje= 
length(which(educ==4))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media humanista completa por comnuna
BDC_educ_hum_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educhumcompleta_porcentaje= 
length(which(educ==5))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media técnica profesional completa por comuna 
BDC_educ_tec_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educteccomplete_porcentaje= 
length(which(educ==6))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))



#Porcentaje de Técnico nivel Superior incompleta por comuna
BDC_educ_sup_tec_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuptecincomplete_porcentaje= 
length(which(educ==7))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Técnico nivel Superior completo por comuna
BDC_educ_sup_tec_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupteccomplete_porcentaje=
length(which(educ==8))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))


#Porcentaje de Profesional incompleto por comuna
BDC_educ_sup_prof_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupprofincomplete_porcentaje= 
length(which(educ==9))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))


#Porcentaje de Postgrado incompleto por comuna 
BDC_educ_sup_post_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuppostincomplete_porcentaje= 
length(which(educ==10))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Profesional completo por comuna
BDC_educ_sup_prof_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupprofcomplete_porcentaje= 
length(which(educ==11))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Postgrado completo por comuna
BDC_educ_sup_post_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuppostcomplete_porcentaje= 
length(which(educ==12))
/(length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Merge niveles educacionales según completo e incompleto por comuna 
BDC_educ_basiclevel <- merge(BDC_educ_basic_complete, BDC_educ_basic_incomplete, by = "comuna")
BDC_educ_sineduc_basiclevel <- merge(BDC_educ_sin, BDC_educ_basiclevel, by = "comuna")
BDC_educ_humlevel <- merge(BDC_educ_hum_complete, BDC_educ_hum_incomplete, by = "comuna")
BDC_educ_teclevel <- merge(BDC_educ_tec_complete, BDC_educ_tec_incomplete, by = "comuna")
BDC_educ_sup_proflevel <- merge(BDC_educ_sup_prof_complete, BDC_educ_sup_prof_incomplete, by = "comuna")
BDC_educ_sup_teclevel <- merge(BDC_educ_sup_tec_complete, BDC_educ_sup_tec_incomplete, by = "comuna")
BDC_educ_sup_postlevel <- merge(BDC_educ_sup_post_complete, BDC_educ_sup_post_incomplete, by = "comuna")

BDC_media <- merge(BDC_educ_humlevel, BDC_educ_teclevel, by = "comuna")
BDC_mediaybasica <- merge(BDC_educ_sineduc_basiclevel, BDC_media, by = "comuna")
BDC_superior <- merge(BDC_educ_sup_teclevel, BDC_educ_sup_proflevel, by = "comuna")
BDC_superiorypost <- merge(BDC_superior, BDC_educ_sup_postlevel, by = "comuna")
BDC_niveleducacional <- merge(BDC_mediaybasica, BDC_superiorypost, by = "comuna")

#comprobar
BDC_niveleducacional$total_niveleducacional <- BDC_niveleducacional$sineducformal_porcentaje + BDC_niveleducacional$educbasicincomplete_porcentaje + BDC_niveleducacional$educbasiccomplete_porcentaje + BDC_niveleducacional$educhumincomplete_porcentaje + BDC_niveleducacional$eductecincomplete_porcentaje +  BDC_niveleducacional$educhumcompleta_porcentaje + BDC_niveleducacional$educteccomplete_porcentaje + BDC_niveleducacional$educsuptecincomplete_porcentaje + BDC_niveleducacional$educsupteccomplete_porcentaje + BDC_niveleducacional$educsupprofincomplete_porcentaje + BDC_niveleducacional$educsuppostincomplete_porcentaje + BDC_niveleducacional$educsupprofcomplete_porcentaje + BDC_niveleducacional$educsuppostcomplete_porcentaje

any(BDC_niveleducacional$total_niveleducacional == ! 1)

# Deciles por comuna
# Porcentaje decil 1 por comuna
BDC_decil1 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil1_porcentaje= length(which(decilautonomo==1))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 2 por comuna
BDC_decil2 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil2_porcentaje= length(which(decilautonomo==2))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 3 por comuna
BDC_decil3 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil3_porcentaje= length(which(decilautonomo==3))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 4 por comuna
BDC_decil4 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil4_porcentaje= length(which(decilautonomo==4))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 5 por comuna
BDC_decil5 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil5_porcentaje= length(which(decilautonomo==5))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 6 por comuna
BDC_decil6 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil6_porcentaje= length(which(decilautonomo==6))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 7 por comuna
BDC_decil7 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil7_porcentaje= length(which(decilautonomo==7))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 8 por comuna
BDC_decil8 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil8_porcentaje= length(which(decilautonomo==8))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 9 por comuna
BDC_decil9 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil9_porcentaje= length(which(decilautonomo==9))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 10 por comuna
BDC_decil10 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil10_porcentaje= length(which(decilautonomo==10))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))
# Merges
BDC_d1yd2 <- merge(BDC_decil1, BDC_decil2, by = "comuna")
BDC_d3yd4 <- merge (BDC_decil3, BDC_decil4, by = "comuna")
BDC_d5yd6 <- merge(BDC_decil5, BDC_decil6, by = "comuna")
BDC_d7yd8 <- merge(BDC_decil7, BDC_decil8, by = "comuna")
BDC_d9yd10 <- merge(BDC_decil9, BDC_decil10, by = "comuna")
BDC_d1d2d3d4 <- merge(BDC_d1yd2, BDC_d3yd4, by = "comuna")
BDC_d5d6d7d8 <- merge(BDC_d5yd6, BDC_d7yd8, by = "comuna")
BDC_descs <- merge(BDC_d1d2d3d4, BDC_d5d6d7d8, by = "comuna")
BDC_deciles <- merge(BDC_descs, BDC_d9yd10, by = "comuna")

# Comprobar
BDC_deciles$total_deciles <- BDC_deciles$decil1_porcentaje + BDC_deciles$decil2_porcentaje + BDC_deciles$decil3_porcentaje + BDC_deciles$decil4_porcentaje + BDC_deciles$decil5_porcentaje + BDC_deciles$decil6_porcentaje + BDC_deciles$decil7_porcentaje + BDC_deciles$decil8_porcentaje + BDC_deciles$decil9_porcentaje + BDC_deciles$decil10_porcentaje

any (BDC_deciles$total_deciles == !1)

#Merge de variables categoricas
BDC_sexysistsalud <- merge(BDC_sex, BDC_sistsalud, by = "comuna")
BDC_saludydeciles <- merge(BDC_sexysistsalud, BDC_deciles, by = "comuna")
BDC_cat <- merge(BDC_niveleducacional, BDC_saludydeciles, by = "comuna")

#*NOTA* La variable educ (en categorías) no se agrupará pues se considera que la variable años de educación cumple esa función y además hace la base más parsimoniosa. 
```

Una vez agrupadas las nuevas variables en aquellas numericas y categoricas, procedemos a unirlas en una sola base
```{r}
BDC <- merge(BDC_num, BDC_cat, by = "comuna")
```

Hemos completado el tratamiento de la CASEN 2017. Ahora queda unirla a la base de datos de infectados con COVID 19
```{r}
#Unir bases
class(BDC)
class(BCV19c)
BDCV19 <- merge(BCV19c, BDC, by = "comuna")
```

Una vez realizado esto, podemos guardar la base en el formato que queramos, en este caso será .xlsx
```{r}
write.xlsx(BDCV19, "CASEN-COVID19.xlsx")
```

## Segunda sección: algunos descriptivos básicos

Tabla de contingencia seleccionando variables de interes. 

```{r}
#Tabla Comuna y sistema de salud
sjt.xtab(BDCV19$Comuna, BDCV19$total_sistsalud, 
         show.col.prc=TRUE,
        show.summary=FALSE)

```

Correlación R de Pearsons. 
```{r}
res <- cor.test(BDCV19$Casos.Confirmados, BDCV19$ingresohogar_media, 
                    method = "pearson")
res

```


